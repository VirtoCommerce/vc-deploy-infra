apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: init-platform-template
spec:
  arguments:
    parameters:
      - name: resource
        value: "JSON"
  volumes:
  - name: workdir
    persistentVolumeClaim:
      claimName: "{{steps.parse.outputs.parameters.instance}}-modules-volume"
  templates:
    - name: init-platform
      inputs:
        parameters:
          - name: resource
      steps:
      - - name: parse
          template: parser
          arguments:
            parameters:
            - name: json
              value: "{{inputs.parameters.resource}}"
      - - name: installer-modules
          template: install-modules 
          arguments:
            parameters:
            - name: namespace
              value: "{{steps.parse.outputs.parameters.namespace}}"
            - name: instance
              value: "{{steps.parse.outputs.parameters.instance}}"
            - name: modules_json
              value: "{{steps.parse.outputs.parameters.modules_json}}"

    - name: parser
      inputs:
        parameters:
          - name: json
      container:
        image: kkisilevsky/alpine-jq
        command: [sh, -c]
        args:
          - "echo -n '{{inputs.parameters.json}}' | jq -r '.metadata.namespace' > /tmp/namespace.txt
          && echo -n '{{inputs.parameters.json}}' | jq -r '.metadata.labels.instance' > /tmp/instance.txt
          && echo -n '{{inputs.parameters.json}}' | jq -r '.data.modules_json' > /tmp/modules_json.txt"
      outputs:
        parameters:
          - name: namespace
            valueFrom:
              path: /tmp/namespace.txt
          - name: instance
            valueFrom:
              path: /tmp/instance.txt
          - name: modules_json
            valueFrom:
              path: /tmp/modules_json.txt

    - name: install-modules
      inputs:
        parameters:
          - name: namespace
          - name: instance
          - name: modules_json
      resource:
        action: create
        manifest: |               #put your kubernetes spec here
          apiVersion: batch/v1
          kind: Job
          metadata:
            generateName: modules-installer-job-
            namespace: "{{inputs.parameters.namespace}}"
          spec:
            template:
              metadata:
                name: modules-installer
              spec:
                containers:
                - name: modules-installer
                  image: docker.pkg.github.com/virtocommerce/vc-deploy-containers/platform-installer:v3
                  env:
                  - name: MODULES_CONFIG
                    value: "TEST"
                  command:
                    - "/bin/sh"
                    - "-c"
                  args:
                    - "echo START INIT $(date +%Y-%m-%d-%H-%M-%S)
                    && python3 install-modules.py \"{{inputs.parameters.modules_json}}\" /mnt/Modules/*"
                  volumeMounts:
                  - name: modules-volume
                    mountPath: /mnt/Modules
                    readOnly: false
                volumes:
                - name: modules-volume
                  persistentVolumeClaim:
                    claimName: "{{inputs.parameters.instance}}-modules-volume"
                restartPolicy: Never
            backoffLimit: 2
      # resource:
      #   action: create
      #   manifest: |
      #     apiVersion: batch/v1
      #     kind: Job
      #     metadata:
      #       generateName: install-modules-
      #       namespace: "{{inputs.parameters.namespace}}"
      #     spec:
      #       template:
      #         metadata:
      #           name: install-modules
      #         spec:
      #           containers:
      #           - name: install-modules
      #             image: kkisilevsky/alpine-jq
      #             command:
      #               - "/bin/sh"
      #               - "-c"
      #             args:
      #               - "echo -n '{{inputs.parameters.modules_json}}' > /mnt/modules/json.txt"
      #             volumeMounts:
      #             - name: modules-volume
      #               mountPath: /mnt/modules
      #               readOnly: false
      #           volumes:
      #           - name: modules-volume
      #             persistentVolumeClaim:
      #               claimName: "{{inputs.parameters.instance}}-modules-volume"
      #           restartPolicy: Never